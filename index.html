<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Usuarios - Junta de Saneamiento</title>
  <meta name="description" content="Consulta de pagos y estado de usuarios de la Junta de Saneamiento - Junta San Ramón">
  <!-- Fuente moderna -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <!-- Íconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header" role="banner">
    <div class="container header-inner">
      <div class="brand">
        <i class="fa-solid fa-faucet-drip" aria-hidden="true"></i>
        <h1>Consulta de Usuarios - Junta San Ramón</h1>
      </div>
    </div>
  </header>

  <main class="container" role="main">
    <section aria-labelledby="search-title" class="search-section">
      <h2 id="search-title" class="visually-hidden">Buscador de usuarios</h2>
      <form id="form-buscar" class="search-form" onsubmit="event.preventDefault(); buscarUsuario();" role="search" aria-label="Buscar usuarios">
        <label for="buscar" class="visually-hidden">Buscar usuario por nombre, cédula o lote</label>
        <input type="search" id="buscar" name="buscar" placeholder="Ingrese nombre, cédula o lote..." aria-label="Buscar" autocomplete="off">
        <div class="buttons">
          <button type="button" id="btn-buscar" class="btn primary" aria-label="Buscar"><i class="fa fa-search" aria-hidden="true"></i> Buscar</button>
          <button type="button" id="btn-limpiar" class="btn" aria-label="Limpiar búsqueda"><i class="fa fa-eraser" aria-hidden="true"></i> Limpiar</button>
        </div>
      </form>
    </section>

    <section id="resultados" class="resultados" aria-live="polite"></section>
  </main>

  <footer class="site-footer" role="contentinfo">
    <div class="container">
      <p>© <span id="year"></span> Junta San Ramón • Datos proporcionados por la administración.</p>
    </div>
  </footer>

  <script>
    // Variables de estado
    let usuarios2024 = [];
    let usuarios2025 = [];
    const resultadosEl = document.getElementById('resultados');
    const inputBuscar = document.getElementById('buscar');
    const btnBuscar = document.getElementById('btn-buscar');
    const btnLimpiar = document.getElementById('btn-limpiar');

    // Mostrar año en footer
    document.getElementById('year').textContent = new Date().getFullYear();

    // Cargar datos con manejo de errores
    async function cargarDatos() {
      try {
        const [r2024, r2025] = await Promise.all([
          fetch('PAGOS_2024.json'),
          fetch('PAGOS_2025.json')
        ]);
        if (!r2024.ok || !r2025.ok) throw new Error('No se pudieron cargar los archivos de datos.');
        usuarios2024 = await r2024.json();
        usuarios2025 = await r2025.json();
      } catch (err) {
        console.error(err);
        resultadosEl.innerHTML = `<div class="info">Error al cargar los datos. Por favor revise que los archivos PAGOS_2024.json y PAGOS_2025.json estén disponibles.</div>`;
      }
    }

    cargarDatos();

    // Debounce utility para evitar búsquedas excesivas
    function debounce(fn, delay = 300) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    // Búsqueda principal (case-insensitive)
    function realizarBusqueda(query) {
      if (!query) {
        resultadosEl.innerHTML = '';
        return;
      }
      const q = query.toLowerCase();
      const filtrar = (u) => Object.values(u).some(v => String(v).toLowerCase().includes(q));
      const res24 = usuarios2024.filter(filtrar);
      const res25 = usuarios2025.filter(filtrar);

      resultadosEl.innerHTML = '';
      let total = 0;
      total += mostrarResultados(res24, 2024);
      total += mostrarResultados(res25, 2025);

      if (total === 0) {
        resultadosEl.innerHTML = `<div class="info">No se encontraron resultados para: <strong>${escapeHtml(query)}</strong></div>`;
      }
    }

    const buscarUsuario = debounce(() => realizarBusqueda(inputBuscar.value.trim()), 250);

    // Event listeners
    inputBuscar.addEventListener('input', buscarUsuario);
    btnBuscar.addEventListener('click', () => realizarBusqueda(inputBuscar.value.trim()));
    btnLimpiar.addEventListener('click', () => { inputBuscar.value = ''; resultadosEl.innerHTML = ''; inputBuscar.focus(); });

    // Escapar HTML básico
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // Mostrar resultados agrupados por año
    function mostrarResultados(lista, anio) {
      if (!lista || lista.length === 0) return 0;
      const fragment = document.createDocumentFragment();
      const section = document.createElement('section');
      section.className = 'grupo-anio';
      section.innerHTML = `<h3 class="anio">Resultados ${anio} <span class="count">(${lista.length})</span></h3>`;

      const grid = document.createElement('div');
      grid.className = 'grid-cards';

      const meses = ["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SETIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];

      lista.forEach(u => {
        let badges = '';
        meses.forEach(m => {
          if (u[m]) {
            badges += `<span class="badge"><i class="fa fa-check" aria-hidden="true"></i> ${m}</span>`;
          } else {
            badges += `<span class="badge pendiente"><i class="fa fa-times" aria-hidden="true"></i> ${m}</span>`;
          }
        });

        let estadoBadge = '';
        if (typeof u['Estado'] === 'string') {
          const estado = u['Estado'].trim().toLowerCase();
          if (estado === 'recien conectado') estadoBadge = `<span class="estado conectado">Recien conectado</span>`;
          else if (estado === 'sin conexion' || estado === 'sin conexión') estadoBadge = `<span class="estado desconectado">Sin conexión</span>`;
        }

        const card = document.createElement('article');
        card.className = 'card';
        card.tabIndex = 0;
        card.innerHTML = `
          <header class="card-header">
            <h4 class="card-title">${escapeHtml(u['Nombres y Apellidos:'] || '-')}</nobr></h4>
            <div class="meta">${escapeHtml(u['Cédula de Identidad:'] || '-')}${estadoBadge}</div>
          </header>
          <div class="card-body">
            <p><strong>Año:</strong> ${anio}</p>
            <p><strong>Nº:</strong> ${escapeHtml(u['Nº'] || '-')}</p>
            <p><strong>Manzana:</strong> ${escapeHtml(u['Manzana'] || '-')}</p>
            <p><strong>Lote:</strong> ${escapeHtml(u['Lote'] || '-')}</p>
            <div class="seccion pagos">
              <p><strong>Total a Pagar:</strong> ${escapeHtml(u['TOTAL A PAGAR'] || '-')}</p>
              <p><strong>Pagado:</strong> ${escapeHtml(u['PAGADO'] || '-')}</p>
              <p><strong>Saldo:</strong> ${escapeHtml(u['SALDO A PAGAR'] || '-')}</p>
              <p><strong>Observación:</strong> ${escapeHtml(u['Observación'] || '-')}</p>
            </div>
            <div class="seccion meses">
              <p><strong>Meses:</strong></p>
              <div class="badges">${badges}</div>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });

      section.appendChild(grid);
      fragment.appendChild(section);
      resultadosEl.appendChild(fragment);
      return lista.length;
    }
  </script>
</body>
</html>